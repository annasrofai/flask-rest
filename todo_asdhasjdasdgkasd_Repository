from pymongo import MongoClient
from bson import json_util, ObjectId
import json
from datetime import datetime


class TweetDataRepository:

    def __init__(self):
        self.client = MongoClient('localhost', 27017)
        self.db = self.client.TwitterStream
        self.tweet_data = self.db.coba

    # def get_id(self, todo_id):
    #     todo = self.todos.find_one({"_id": ObjectId(todo_id)})
    #     todo = json.loads(json_util.dumps(todo))
    #     todo["_id"] = todo["_id"]["$oid"]
    #     todo["created"] = todo["created"]["$date"]
    #     return todo

    def get_all(self):
        cursor = self.tweet_data.find({})
        tweet_data = list(cursor)
        tweet_data = json.loads(json_util.dumps(tweet_data))
        for item in tweet_data:
            item["_id"] = item["_id"]["$oid"]
            item["created"] = item["created"]["$date"]
        return tweet_data

    # def get_all_username(self, username):
    #     cursor = self.todos.find({"username": username})
    #     todos = list(cursor)
    #     todos = json.loads(json_util.dumps(todos))
    #     for item in todos:
    #         item["_id"] = item["_id"]["$oid"]
    #         item["created"] = item["created"]["$date"]
    #     return todos

    def get_all_provider(self, provider):
        cursor = self.TweetDataRepository.find({"provider": provider})
        tweet_data = list(cursor)
        tweet_data = json.loads(json_util.dumps(tweet_data))
        for item in tweet_data:
            item["_id"] = item["_id"]["$oid"]
            item["created"] = item["created"]["$date"]
        return tweet_data

    def get_all_provider_date(self, provider, tanggal):
        from_str = tanggal
        until_str = tanggal
        # until_str = "2022-06-18"
        from_date_str = from_str + "T00:00:00+00:00"
        to_date_str = until_str + "T23:59:59+00:00"
        from_date = datetime.strptime(from_date_str, '%Y-%m-%dT%H:%M:%S%z')
        to_date = datetime.strptime(to_date_str, '%Y-%m-%dT%H:%M:%S%z')
        criteria = {"$and": [{"created": {"$gte": from_date, "$lte": to_date}}, {
            "provider": provider}]}
        cursor = self.tweet_data.find(criteria)
        tweet_data = list(cursor)
        tweet_data = json.loads(json_util.dumps(tweet_data))
        for item in tweet_data:
            item["_id"] = item["_id"]["$oid"]
            item["created"] = item["created"]["$date"]
        return tweet_data

    def get_all_date(self, tanggal):
        from_str = tanggal
        until_str = tanggal
        # until_str = "2022-06-18"
        from_date_str = from_str + "T00:00:00+00:00"
        to_date_str = until_str + "T23:59:59+00:00"
        from_date = datetime.strptime(from_date_str, '%Y-%m-%dT%H:%M:%S%z')
        to_date = datetime.strptime(to_date_str, '%Y-%m-%dT%H:%M:%S%z')
        cursor = self.tweet_data.find({"created": {
            "$gte": from_date, "$lte": to_date}})
        tweet_data = list(cursor)
        tweet_data = json.loads(json_util.dumps(tweet_data))
        for item in tweet_data:
            item["_id"] = item["_id"]["$oid"]
            item["created"] = item["created"]["$date"]
        return tweet_data
